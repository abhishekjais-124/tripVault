{% extends "trip/base.html" %}
{% load static %}

{% block title %}Support - TripVault{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 pt-24 pb-16">
    <div class="max-w-4xl mx-auto px-4">
        <!-- Support Header -->
        <div class="mb-12">
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold gradient-text mb-4">Support Center</h1>
                <p class="text-gray-400 text-lg">We're here to help! Get answers and support.</p>
            </div>
        </div>

        <!-- Two Column Layout -->
        <div class="grid md:grid-cols-2 gap-8">
            <!-- FAQ Section -->
            <div class="glass rounded-2xl p-8 border border-gray-700">
                <h2 class="text-2xl font-bold gradient-text mb-6">Frequently Asked Questions</h2>
                
                <div class="space-y-6">
                    <!-- FAQ Item 1 -->
                    <div class="border-b border-gray-700 pb-4">
                        <button class="faq-toggle w-full text-left flex items-start justify-between group" onclick="toggleFAQ(this)">
                            <span class="font-semibold text-gray-300 group-hover:text-cyan-400 transition-colors flex-1">
                                How do I create a group?
                            </span>
                            <i class="fas fa-chevron-down text-gray-500 group-hover:text-cyan-400 transition-colors mt-1 ml-4 flex-shrink-0"></i>
                        </button>
                        <p class="faq-content hidden text-gray-400 mt-3">
                            Go to the Groups section from the navigation menu, click "Create Group", enter the group details, and invite members using their username. You can set group descriptions to help everyone understand the trip details.
                        </p>
                    </div>

                    <!-- FAQ Item 2 -->
                    <div class="border-b border-gray-700 pb-4">
                        <button class="faq-toggle w-full text-left flex items-start justify-between group" onclick="toggleFAQ(this)">
                            <span class="font-semibold text-gray-300 group-hover:text-cyan-400 transition-colors flex-1">
                                How do I add expenses?
                            </span>
                            <i class="fas fa-chevron-down text-gray-500 group-hover:text-cyan-400 transition-colors mt-1 ml-4 flex-shrink-0"></i>
                        </button>
                        <p class="faq-content hidden text-gray-400 mt-3">
                            Open a group and click "Add Expense". Enter the amount, description, who paid, and who should split the cost. TripVault will automatically calculate who owes whom.
                        </p>
                    </div>

                    <!-- FAQ Item 3 -->
                    <div class="border-b border-gray-700 pb-4">
                        <button class="faq-toggle w-full text-left flex items-start justify-between group" onclick="toggleFAQ(this)">
                            <span class="font-semibold text-gray-300 group-hover:text-cyan-400 transition-colors flex-1">
                                How is the balance calculated?
                            </span>
                            <i class="fas fa-chevron-down text-gray-500 group-hover:text-cyan-400 transition-colors mt-1 ml-4 flex-shrink-0"></i>
                        </button>
                        <p class="faq-content hidden text-gray-400 mt-3">
                            TripVault tracks all expenses and splits them equally among members (or according to custom splits you set). Your balance shows how much you've paid vs. how much you owe. Positive balance means you're owed money, negative means you owe money.
                        </p>
                    </div>

                    <!-- FAQ Item 4 -->
                    <div class="border-b border-gray-700 pb-4">
                        <button class="faq-toggle w-full text-left flex items-start justify-between group" onclick="toggleFAQ(this)">
                            <span class="font-semibold text-gray-300 group-hover:text-cyan-400 transition-colors flex-1">
                                How do I view my Friends?
                            </span>
                            <i class="fas fa-chevron-down text-gray-500 group-hover:text-cyan-400 transition-colors mt-1 ml-4 flex-shrink-0"></i>
                        </button>
                        <p class="faq-content hidden text-gray-400 mt-3">
                            Friends are any users you share groups with. Visit the Friends page from the navigation menu to see all your friends, their overall balance with you, and which groups you share together.
                        </p>
                    </div>

                    <!-- FAQ Item 5 -->
                    <div>
                        <button class="faq-toggle w-full text-left flex items-start justify-between group" onclick="toggleFAQ(this)">
                            <span class="font-semibold text-gray-300 group-hover:text-cyan-400 transition-colors flex-1">
                                How do I manage group invitations?
                            </span>
                            <i class="fas fa-chevron-down text-gray-500 group-hover:text-cyan-400 transition-colors mt-1 ml-4 flex-shrink-0"></i>
                        </button>
                        <p class="faq-content hidden text-gray-400 mt-3">
                            You'll receive notifications for group invitations. Visit the Activities page to see pending invitations, and you can accept or decline them. Your admin can also manage members and their roles within each group.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contact Form Section -->
            <div class="glass rounded-2xl p-8 border border-gray-700">
                <h2 class="text-2xl font-bold gradient-text mb-6">Contact Us</h2>
                
                <form id="contactForm" class="space-y-5">
                    <!-- Name Field -->
                    <div>
                        <label for="name" class="block text-gray-300 font-semibold mb-2">Name</label>
                        <input 
                            type="text" 
                            id="name" 
                            name="name"
                            placeholder="Your name"
                            required
                            class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 transition-all"
                        />
                    </div>

                    <!-- Email Field -->
                    <div>
                        <label for="email" class="block text-gray-300 font-semibold mb-2">Email</label>
                        <input 
                            type="email" 
                            id="email" 
                            name="email"
                            placeholder="your@email.com"
                            required
                            class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 transition-all"
                        />
                    </div>

                    <!-- Subject Field -->
                    <div>
                        <label for="subject" class="block text-gray-300 font-semibold mb-2">Subject</label>
                        <input 
                            type="text" 
                            id="subject" 
                            name="subject"
                            placeholder="How can we help?"
                            required
                            class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 transition-all"
                        />
                    </div>

                    <!-- Message Field -->
                    <div>
                        <label for="message" class="block text-gray-300 font-semibold mb-2">Message</label>
                        <textarea 
                            id="message" 
                            name="message"
                            placeholder="Tell us more about your issue or question..."
                            rows="5"
                            required
                            class="w-full px-4 py-3 bg-gray-800/50 border border-gray-600 rounded-lg text-gray-200 placeholder-gray-500 focus:outline-none focus:border-cyan-400 focus:ring-2 focus:ring-cyan-400/20 transition-all resize-none"
                        ></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button 
                        type="submit"
                        class="w-full py-3 bg-gradient-to-r from-cyan-400 to-blue-500 text-gray-900 font-bold rounded-lg hover:shadow-lg hover:shadow-cyan-400/50 transition-all duration-300 flex items-center justify-center space-x-2"
                    >
                        <i class="fas fa-paper-plane"></i>
                        <span>Send Message</span>
                    </button>

                    <!-- Status Messages -->
                    <div id="successMessage" class="hidden p-4 bg-green-500/20 border border-green-500/50 text-green-300 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-check-circle"></i>
                        <span>Message sent successfully! We'll get back to you soon.</span>
                    </div>
                    <div id="errorMessage" class="hidden p-4 bg-red-500/20 border border-red-500/50 text-red-300 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-exclamation-circle"></i>
                        <span id="errorText">Failed to send message. Please try again.</span>
                    </div>
                </form>
            </div>
        </div>

        <!-- Support Info Section -->
        <div class="mt-12 grid md:grid-cols-3 gap-6">
            <!-- Response Time -->
            <div class="glass rounded-xl p-6 border border-gray-700 text-center">
                <div class="mb-4">
                    <i class="fas fa-clock text-3xl gradient-text"></i>
                </div>
                <h3 class="font-bold text-gray-200 mb-2">Fast Response</h3>
                <p class="text-gray-400 text-sm">We typically respond within 24 hours</p>
            </div>

            <!-- Available Support -->
            <div class="glass rounded-xl p-6 border border-gray-700 text-center">
                <div class="mb-4">
                    <i class="fas fa-headset text-3xl gradient-text"></i>
                </div>
                <h3 class="font-bold text-gray-200 mb-2">Expert Support</h3>
                <p class="text-gray-400 text-sm">Our team is here to help with any questions</p>
            </div>

            <!-- Community Help -->
            <div class="glass rounded-xl p-6 border border-gray-700 text-center">
                <div class="mb-4">
                    <i class="fas fa-book text-3xl gradient-text"></i>
                </div>
                <h3 class="font-bold text-gray-200 mb-2">Documentation</h3>
                <p class="text-gray-400 text-sm">Check our FAQ for instant answers</p>
            </div>
        </div>
    </div>
</div>

<!-- emailJS Script -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
    // Initialize emailJS with Service ID
    // Note: You need to set up a template in emailJS console
    // Service ID: service_1
    // Template: template_contact
    emailjs.init('service_1');

    // FAQ Toggle Function
    function toggleFAQ(button) {
        const content = button.nextElementSibling;
        const icon = button.querySelector('i');
        
        content.classList.toggle('hidden');
        icon.classList.toggle('rotate-180');
        icon.style.transition = 'transform 0.3s ease';
    }

    // Handle Form Submission
    document.getElementById('contactForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const successMsg = document.getElementById('successMessage');
        const errorMsg = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const submitBtn = document.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        
        // Hide messages
        successMsg.classList.add('hidden');
        errorMsg.classList.add('hidden');

        // Disable submit button
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner animate-spin"></i><span>Sending...</span>';

        // Prepare form data
        const formData = {
            from_name: document.getElementById('name').value,
            from_email: document.getElementById('email').value,
            subject: document.getElementById('subject').value,
            message: document.getElementById('message').value,
            to_email: 'support@tripvault.com'
        };

        // Try emailJS first if template is configured
        const sendViaEmailJS = () => {
            return new Promise((resolve, reject) => {
                emailjs.send('service_1', 'template_contact', formData)
                    .then(
                        function(response) {
                            console.log('EmailJS SUCCESS!', response.status, response.text);
                            resolve({ success: true });
                        },
                        function(error) {
                            console.log('EmailJS FAILED!', error);
                            reject(error);
                        }
                    );
            });
        };

        // Fallback to backend endpoint if emailJS is not configured
        const sendViaBackend = () => {
            return fetch('{% url "send-contact-email" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json());
        };

        // Try emailJS first, fallback to backend
        sendViaEmailJS()
            .then(
                function(result) {
                    console.log('Message sent via emailJS');
                    showSuccessMessage();
                },
                function(error) {
                    console.log('EmailJS not configured, trying backend...');
                    // Fallback to backend
                    return sendViaBackend().then(result => {
                        if (result.success) {
                            showSuccessMessage();
                        } else {
                            showErrorMessage(result.error || 'Failed to send message');
                        }
                    });
                }
            )
            .catch(error => {
                console.error('Error:', error);
                showErrorMessage('Failed to send message. Please try again.');
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });

        function showSuccessMessage() {
            successMsg.classList.remove('hidden');
            document.getElementById('contactForm').reset();
            
            // Hide success message after 5 seconds
            setTimeout(() => {
                successMsg.classList.add('hidden');
            }, 5000);
        }

        function showErrorMessage(message) {
            errorText.textContent = message;
            errorMsg.classList.remove('hidden');
        }
    });
</script>

<style>
    .gradient-text {
        background: linear-gradient(135deg, #06b6d4, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .glass {
        background: rgba(15, 23, 42, 0.7);
        backdrop-filter: blur(10px);
    }

    .faq-content {
        transition: all 0.3s ease;
    }

    button[onclick*="toggleFAQ"] i {
        transition: transform 0.3s ease;
    }
</style>
{% endblock body %}
